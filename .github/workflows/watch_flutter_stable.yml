name: Watch Flutter Stable Releases

on:
  schedule:
    - cron: "0 */12 * * *"   # every 12 hours
  workflow_dispatch:        # manual trigger for testing

permissions:
  contents: read
  actions: write

concurrency:
  group: flutter-stable-watch
  cancel-in-progress: false

jobs:
  watch:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # 1ï¸âƒ£ Fetch latest Flutter stable tag
      # -----------------------------
      - name: Fetch Flutter stable tag
        id: flutter
        run: |
          git clone --quiet https://github.com/flutter/flutter.git
          cd flutter

          LATEST=$(git tag --list \
            | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' \
            | sort -V \
            | tail -n 1)

          if [ -z "$LATEST" ]; then
            echo "âŒ Failed to determine Flutter stable version"
            exit 1
          fi

          echo "latest=$LATEST" >> $GITHUB_OUTPUT
          echo "ğŸŸ¢ Latest Flutter stable tag: $LATEST"

      # -----------------------------
      # 2ï¸âƒ£ Get last published SDK version
      # -----------------------------
      - name: Get last published SDK version
        id: last
        run: |
          LAST_TAG=$(gh release list \
            --repo MohamedAlkindi/flutter-native-arm64 \
            --limit 1 \
            --json tagName \
            --jq '.[0].tagName' || true)
      
          if [ -z "$LAST_TAG" ]; then
            echo "âš ï¸ No previous releases found"
            echo "last=none" >> $GITHUB_OUTPUT
          else
            CLEAN_VERSION=$(echo "$LAST_TAG" \
              | sed 's/^flutter-//' \
              | sed 's/-.*//')
      
            echo "last=$CLEAN_VERSION" >> $GITHUB_OUTPUT
            echo "ğŸ“¦ Last published SDK version: $CLEAN_VERSION"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # -----------------------------
      # 3ï¸âƒ£ Decide whether to trigger build
      # -----------------------------
      - name: Compare versions
        id: compare
        run: |
          LATEST="${{ steps.flutter.outputs.latest }}"
          LAST="${{ steps.last.outputs.last }}"

          echo "ğŸ” Comparing versions"
          echo "   Flutter latest: $LATEST"
          echo "   Last built:     $LAST"

          if [ "$LAST" = "none" ]; then
            echo "trigger=true" >> $GITHUB_OUTPUT
            echo "ğŸ†• First SDK build â€” triggering"
          elif [ "$LATEST" = "$LAST" ]; then
            echo "trigger=false" >> $GITHUB_OUTPUT
            echo "ğŸŸ¡ No new stable release â€” skipping"
          else
            echo "trigger=true" >> $GITHUB_OUTPUT
            echo "ğŸš€ New Flutter stable detected â€” triggering build"
          fi

      # -----------------------------
      # 4ï¸âƒ£ Trigger ARM64 SDK build workflow
      # -----------------------------
      - name: Trigger ARM64 SDK build
        if: steps.compare.outputs.trigger == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            console.log("ğŸš€ Dispatching build workflow (main.yml)...");
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: "main.yml",
              ref: "main"
            })
