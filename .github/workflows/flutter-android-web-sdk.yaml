name: Flutter ARM64 Full Native SDK (Android + Web)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: [self-hosted, linux-arm64]

    steps:
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git unzip curl xz-utils zip python3 clang cmake ninja-build pkg-config \
            libgtk-3-dev liblzma-dev libssl-dev libcurl4-openssl-dev libfreetype6-dev \
            libfontconfig1-dev libc6-dev gcc g++ make file wget

      - name: Clone Flutter
        run: |
          git clone https://github.com/flutter/flutter.git -b stable --depth 1 flutter

      - name: Setup depot_tools
        run: |
          git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
          export PATH="$PATH:$(pwd)/depot_tools:$PATH"

      - name: Precache engines for Android + Web
        run: |
          cd flutter
          ./bin/flutter precache --android --web --no-linux --no-ios --no-windows --no-macos

      - name: Build Dart SDK for ARM64
        run: |
          cd flutter/bin/cache/dart-sdk
          export PATH="$PATH:$(pwd)/../../../../depot_tools:$PATH"
          ./tools/build.py --mode release --arch arm64 create_sdk
          cd ../../..

      - name: Replace Flutter Dart SDK with ARM64 build
        run: |
          rm -rf flutter/bin/cache/dart-sdk
          mv flutter/bin/cache/dart-sdk/out/ReleaseARM64 flutter/bin/cache/dart-sdk

      - name: Verify Dart binaries are ARM64
        run: |
          cd flutter/bin/cache/dart-sdk/bin
          for f in dart dartaotruntime dart_precompiled_runtime; do
            file "$f" | grep "aarch64" || (echo "$f is not ARM64!" && exit 1)
          done

      - name: Trim SDK to Android + Web only
        run: |
          cd flutter
          rm -rf examples/ dev/ docs/
          rm -rf bin/cache/pkg
          rm -rf bin/cache/artifacts/engine/linux-*
          rm -rf bin/cache/artifacts/engine/windows-*
          rm -rf bin/cache/artifacts/engine/darwin-*
          rm -rf bin/cache/artifacts/engine/ios

      - name: Verify all files are ARM64
        run: |
          cd flutter
          while IFS= read -r f; do
            if [ -f "$f" ]; then
              file "$f" | grep "aarch64" || (echo "ERROR: $f is not ARM64!" && exit 1)
            fi
          done < <(find . -type f)

      - name: Package Flutter ARM64 SDK
        run: |
          cd flutter
          zip -r9 ../flutter-arm64-full-sdk.zip .

      - name: Generate SHA256 checksums
        run: |
          unzip -q ../flutter-arm64-full-sdk.zip -d flutter-sdk-unzip
          cd flutter-sdk-unzip
          find . -type f -exec sha256sum {} \; > ../flutter-sdk-checksums.txt
