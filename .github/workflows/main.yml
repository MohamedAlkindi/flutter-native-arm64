name: Flutter ARM64 Full SDK (Android + Web)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git unzip curl xz-utils zip python3 clang cmake ninja-build pkg-config \
            libgtk-3-dev liblzma-dev libssl-dev libcurl4-openssl-dev libfreetype6-dev \
            libfontconfig1-dev libc6-dev gcc g++ make file wget jq

      - name: Clone Flutter stable
        run: git clone https://github.com/flutter/flutter.git -b stable --depth 1 flutter

      - name: Precache engines
        run: |
          cd flutter
          ./bin/flutter precache --android --web --no-linux --no-ios --no-windows --no-macos

      - name: Rebuild Flutter CLI snapshots for ARM64
        run: |
          # This command ensures all Dart VM snapshots are compiled for the host architecture (ARM64)
          # using the Dart VM already in the precached Flutter SDK.
          cd flutter
          ./bin/flutter --no-enable-analytics --no-enable-web
          
      - name: Verify all binaries and snapshots are ARM64
        run: |
          cd flutter
          find . -type f -executable -print0 | while IFS= read -r -d '' f; do
            file_output=$(file "$f")
            if [[ "$file_output" =~ "ELF" ]]; then
              if [[ ! "$file_output" =~ "aarch64" ]]; then
                echo "Error: Non-ARM64 binary found: $f"
                exit 1
              fi
            fi
          done
          # This step will confirm all snapshots are also aarch64
          file bin/cache/flutter_tools.snapshot

      - name: Package SDK
        run: |
          zip -r9 flutter-arm64-full-sdk.zip flutter

      - name: Generate SHA256 checksums
        run: sha256sum flutter-arm64-full-sdk.zip > flutter-arm64-full-sdk.zip.sha256

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: flutter-arm64-full-sdk
          path: |
            flutter-arm64-full-sdk.zip
            flutter-arm64-full-sdk.zip.sha256
