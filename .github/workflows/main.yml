name: Build Flutter SDK (ARM64 Host, Android + Web only via QEMU)

on:
  workflow_dispatch:

jobs:
  build-flutter-sdk:
    runs-on: ubuntu-latest

    steps:
      - name: Enable QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Flutter SDK inside ARM64 container
        run: |
          docker run --rm --platform linux/arm64 \
            -v $PWD:/workspace \
            -w /workspace \
            arm64v8/ubuntu:22.04 bash -c "
              set -e
              
              # Install deps
              apt-get update
              apt-get install -y git curl unzip xz-utils zip clang ninja-build pkg-config gcc g++ python3 cmake openjdk-17-jdk ca-certificates
              update-ca-certificates
              
              echo '‚úÖ Certificates ready'

              # Clone Flutter SDK
              git clone https://github.com/flutter/flutter.git -b stable --depth 1 flutter
              cd flutter

              # Force download Dart SDK sources for ARM64 host
              ./bin/cache/dart-sdk/bin/dart --version || true
              echo '‚úÖ Dart SDK bootstrapped'

              # Build host artifacts (Linux ARM64)
              echo 'üî® Building Flutter host artifacts (ARM64)'
              ./bin/flutter --verbose --no-version-check doctor

              # Build Web SDK
              echo 'üî® Preparing Flutter Web SDK artifacts'
              ./bin/flutter precache --web
              
              # Build Android engines (all ABIs)
              for ABI in arm arm64 x86 x64; do
                echo 'üî® Building Android engine for ABI: '$ABI
                ./bin/flutter build apk --release --target-platform=android-$ABI --build-shared-library
              done

              # Verify host binaries are ARM64
              echo 'üîç Verifying host binaries are ARM64'
              find bin/cache/dart-sdk/bin -type f -exec file {} \; | grep ELF | grep -v 'ARM aarch64' && { echo '‚ùå Non-ARM64 host binary found'; exit 1; } || echo '‚úÖ All host binaries are ARM64'

              # Strip unnecessary platforms to make it lean
              rm -rf bin/cache/artifacts/engine/darwin-*
              rm -rf bin/cache/artifacts/engine/windows-*
              rm -rf bin/cache/artifacts/engine/linux-x64
              rm -rf bin/cache/artifacts/engine/fuchsia-*
              rm -rf bin/cache/artifacts/engine/ios-*

              # Package SDK
              cd ..
              tar -czf flutter_linux_arm64_android_web_sdk.tar.gz flutter
              echo '‚úÖ Super-lean ARM64 SDK packaged'
            "

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: flutter_linux_arm64_android_web_sdk
          path: flutter_linux_arm64_android_web_sdk.tar.gz
