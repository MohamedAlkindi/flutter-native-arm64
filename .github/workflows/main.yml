name: Flutter ARM64 Full SDK (Android + Web)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git unzip curl xz-utils zip python3 clang cmake ninja-build pkg-config \
            libgtk-3-dev liblzma-dev libssl-dev libcurl4-openssl-dev libfreetype6-dev \
            libfontconfig1-dev libc6-dev gcc g++ make file wget jq

      - name: Clone Flutter stable
        run: git clone https://github.com/flutter/flutter.git -b stable --depth 1 flutter

      - name: Download Dart SDK ARM64
        run: |
          DART_VER=$(curl -s "https://storage.googleapis.com/dart-archive/channels/stable/release/latest/VERSION" | jq -r '.revision')
          wget -O dart-sdk-arm64.zip "https://storage.googleapis.com/dart-archive/channels/stable/release/$DART_VER/linux-arm64/dart-sdk.zip"
          unzip -o dart-sdk-arm64.zip -d flutter/bin/cache/
          mv flutter/bin/cache/dart-sdk flutter/bin/cache/dart-sdk-arm64
          rm dart-sdk-arm64.zip
          mv flutter/bin/cache/dart-sdk-arm64 flutter/bin/cache/dart-sdk
      
      - name: Configure Flutter with ARM64 Dart SDK
        run: |
          cd flutter
          export PATH="$PWD/bin/cache/dart-sdk/bin:$PATH"
          echo "PATH=$PATH" >> $GITHUB_ENV
          ./bin/flutter doctor

      - name: Precache engines
        run: |
          cd flutter
          ./bin/flutter precache --android --web --no-linux --no-ios --no-windows --no-macos
          ./bin/flutter doctor -v

      - name: Verify all binaries and snapshots are ARM64
        run: |
          cd flutter
          find . -type f -executable -print0 | while IFS= read -r -d '' f; do
            file_output=$(file "$f")
            if [[ "$file_output" =~ "ELF" ]]; then
                if [[ ! "$file_output" =~ "aarch64" ]]; then
                    echo "Error: Non-ARM64 binary found: $f"
                    exit 1
                fi
            fi
          done

      - name: Package SDK
        run: |
          zip -r9 flutter-arm64-full-sdk.zip flutter

      - name: Generate SHA256 checksums
        run: sha256sum flutter-arm64-full-sdk.zip > flutter-arm64-full-sdk.zip.sha256

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: flutter-arm64-full-sdk
          path: |
            flutter-arm64-full-sdk.zip
            flutter-arm64-full-sdk.zip.sha256
