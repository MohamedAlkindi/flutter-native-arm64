name: Flutter ARM64 Full SDK (Android + Web)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU for ARM64 emulation
        uses: docker/setup-qemu-action@v3
        with:
          platforms: all

      - name: Build Fully Native ARM64 Flutter SDK
        run: |
          # Write Dockerfile
          cat <<'EOF' > Dockerfile
          FROM --platform=linux/arm64 ubuntu:22.04 AS base

          WORKDIR /app

          # Install dependencies and update certs
          RUN apt-get update && apt-get install -y --no-install-recommends \
              git curl unzip xz-utils cmake clang ninja-build pkg-config \
              libgtk-3-dev liblzma-dev libssl-dev libcurl4-openssl-dev \
              libfreetype6-dev libfontconfig1-dev libc6-dev gcc g++ make \
              file python3 wget jq zip ca-certificates && \
              update-ca-certificates && \
              git config --global http.sslVerify true && \
              rm -rf /var/lib/apt/lists/*

          # Clone Flutter (stable)
          RUN git clone https://github.com/flutter/flutter.git -b stable --depth 1 flutter

          # Get matching engine commit hash
          RUN ENGINE_HASH=$(cat flutter/bin/internal/engine.version) && \
              git clone https://github.com/flutter/engine.git engine && \
              cd engine && \
              git checkout $ENGINE_HASH

          # Build host tools (gen_snapshot, dart, flutter_tester)
          FROM base AS host-tools
          WORKDIR /app/engine
          RUN ./flutter/tools/gn --unoptimized --android --runtime-mode=release \
              --target-platform=android-arm64 --host-arch=arm64
          RUN ninja -C out/host_release
          RUN cp out/host_release/gen_snapshot /app/flutter/bin/cache/artifacts/engine/host_debug_unopt/gen_snapshot && \
              cp out/host_release/dart /app/flutter/bin/cache/dart-sdk/bin/dart && \
              cp out/host_release/flutter_tester /app/flutter/bin/cache/artifacts/engine/host_debug_unopt/flutter_tester && \
              chmod -w /app/flutter/bin/cache/artifacts/engine/host_debug_unopt/gen_snapshot && \
              chmod -w /app/flutter/bin/cache/dart-sdk/bin/dart && \
              chmod -w /app/flutter/bin/cache/artifacts/engine/host_debug_unopt/flutter_tester

          # Build Android ARM64 artifacts
          FROM host-tools AS android-artifacts
          WORKDIR /app/flutter
          RUN mkdir -p bin/cache/artifacts/engine/android-arm64-release && \
              cp -r ../engine/out/host_release/* bin/cache/artifacts/engine/android-arm64-release/

          # Precache Web artifacts only
          FROM android-artifacts AS web-artifacts
          WORKDIR /app/flutter

          # Prevent x64 downloads
          ENV FLUTTER_PREBUILT_BINARIES=false
          ENV FLUTTER_HOST_ARCH=arm64

          RUN ./bin/flutter --disable-analytics
          RUN ./bin/flutter doctor --verbose
          RUN ./bin/flutter precache --web --no-linux --no-windows --no-macos --force

          # Clean and package
          RUN rm -rf examples dev docs bin/cache/pkg
          WORKDIR /app
          RUN zip -r flutter-arm64-full-sdk.zip flutter

          # Final stage
          FROM --platform=linux/arm64 scratch
          COPY --from=web-artifacts /app/flutter-arm64-full-sdk.zip /flutter-arm64-full-sdk.zip
          CMD ["/bin/true"]
          EOF

          # Build Docker image
          docker buildx build --platform linux/arm64 -t flutter-arm64-builder --load .

          # Extract SDK ZIP
          docker create --name flutter-temp-container flutter-arm64-builder
          docker cp flutter-temp-container:/flutter-arm64-full-sdk.zip .
          docker rm flutter-temp-container

      - name: Verify all ELF binaries are ARM64
        run: |
          unzip flutter-arm64-full-sdk.zip -d flutter-sdk-unzip
          if find flutter-sdk-unzip -type f -exec file {} + | grep ELF | grep -v aarch64; then
            echo "❌ Error: Found non-ARM64 binary!"
            exit 1
          else
            echo "✅ All ELF binaries are ARM64."
          fi

      - name: Generate SHA256 checksum
        run: sha256sum flutter-arm64-full-sdk.zip > flutter-arm64-full-sdk.zip.sha256

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: flutter-arm64-full-sdk
          path: |
            flutter-arm64-full-sdk.zip
            flutter-arm64-full-sdk.zip.sha256
