name: Build Flutter SDK (ARM64 Host, Android + Web only via QEMU)

on:
  workflow_dispatch:

jobs:
  build-flutter-sdk:
    runs-on: ubuntu-latest

    steps:
      - name: Enable QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Flutter SDK inside ARM64 container
        run: |
          docker run --rm --platform linux/arm64 \
            -v $PWD:/workspace \
            -w /workspace \
            arm64v8/ubuntu:22.04 bash <<'EOF'
set -e

# Install build dependencies and utilities
apt-get update
apt-get install -y git curl unzip xz-utils zip clang ninja-build pkg-config \
                   gcc g++ python3 cmake openjdk-17-jdk ca-certificates file
update-ca-certificates
echo 'âœ… Certificates and file utility installed'

# Clean workspace
rm -rf flutter

# Clone Flutter SDK
git clone https://github.com/flutter/flutter.git -b stable --depth 1 flutter
cd flutter

# Bootstrap Dart SDK
./bin/cache/dart-sdk/bin/dart --version || true
echo 'âœ… Dart SDK bootstrapped'

# Build host artifacts (Flutter CLI + Dart SDK) for ARM64
echo 'ðŸ”¨ Verifying Flutter host on ARM64'
./bin/flutter --verbose --no-version-check doctor

# Precache Android engine artifacts for all ABIs
echo 'ðŸ”¨ Pre-caching Android engine artifacts (all ABIs)'
./bin/flutter precache --android

# Prepare Web SDK artifacts
echo 'ðŸ”¨ Preparing Flutter Web SDK'
./bin/flutter precache --web

# Verify Dart SDK binaries (only ELF)
echo 'ðŸ” Verifying Dart SDK binaries are ARM64...'
find bin/cache/dart-sdk/bin -type f -executable -exec sh -c '
for f; do
  echo "ðŸ” Checking $f"
  if file "$f" | grep -q ELF; then
    if ! file "$f" | grep -q "ARM aarch64"; then
      echo "âŒ Non-ARM64 Dart binary: $f"
      exit 1
    fi
  fi
done
' sh {} +
echo 'âœ… All Dart SDK binaries are ARM64'

# Verify Flutter engine binaries (only ELF)
echo 'ðŸ” Verifying Flutter engine binaries are ARM64...'
find bin/cache/artifacts/engine/linux-arm64 -type f -exec sh -c '
for f; do
  echo "ðŸ” Checking $f"
  if file "$f" | grep -q ELF; then
    if ! file "$f" | grep -q "ARM aarch64"; then
      echo "âŒ Non-ARM64 engine binary: $f"
      exit 1
    fi
  fi
done
' sh {} +
echo 'âœ… All Flutter engine binaries are ARM64'

# Strip unnecessary platforms
rm -rf bin/cache/artifacts/engine/darwin-*
rm -rf bin/cache/artifacts/engine/windows-*
rm -rf bin/cache/artifacts/engine/linux-x64
rm -rf bin/cache/artifacts/engine/fuchsia-*
rm -rf bin/cache/artifacts/engine/ios-*

# Package SDK
tar -czf /workspace/flutter_linux_arm64_android_web_sdk.tar.gz flutter
echo 'âœ… Super-lean ARM64 SDK packaged at /workspace/flutter_linux_arm64_android_web_sdk.tar.gz'
EOF

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: flutter_linux_arm64_android_web_sdk
          path: flutter_linux_arm64_android_web_sdk.tar.gz
