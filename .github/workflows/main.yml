name: Build Flutter SDK (Linux ARM64 Host, Android + Web only via QEMU)

on:
  workflow_dispatch:
  workflow_call:
permissions:
 contents: write

jobs:
  build-flutter-sdk:
    runs-on: ubuntu-latest

    steps:
      - name: Enable QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Flutter SDK inside ARM64 container
        run: |
          docker run --rm --platform linux/arm64 \
            -v $PWD:/workspace \
            -w /workspace \
            arm64v8/ubuntu:22.04 bash -c "
              # Do not set -e to allow verification to continue on errors

              # Install build dependencies and certificates
              apt-get update
              apt-get install -y git curl unzip xz-utils zip clang ninja-build pkg-config \
                                 gcc g++ python3 cmake openjdk-17-jdk ca-certificates file
              update-ca-certificates
              echo 'âœ… Certificates and file utility installed'

              # Clean workspace
              rm -rf /workspace/flutter
              cd /workspace

              # Clone Flutter SDK
              git clone https://github.com/flutter/flutter.git -b stable --depth 1 flutter
              cd flutter

              # Bootstrap Dart SDK for ARM64 host
              ./bin/cache/dart-sdk/bin/dart --version || echo 'âš  Dart bootstrap skipped'
              echo 'âœ… Dart SDK bootstrapped'

              # Build host artifacts (Flutter CLI + Dart SDK) for ARM64
              echo 'ðŸ”¨ Running Flutter doctor on ARM64'
              ./bin/flutter --verbose --no-version-check doctor || echo 'âš  Flutter doctor skipped'

              # Precache Android engine artifacts for all ABIs
              echo 'ðŸ”¨ Pre-caching Android engine artifacts (all ABIs)'
              ./bin/flutter precache --android || echo 'âš  Android precache skipped'

              # Prepare Web SDK artifacts
              echo 'ðŸ”¨ Preparing Flutter Web SDK'
              ./bin/flutter precache --web || echo 'âš  Web precache skipped'

              # Verify Dart SDK binaries are ARM64
              echo 'ðŸ” Verifying Dart SDK binaries are ARM64...'
              find bin/cache/dart-sdk/bin -type f -executable -exec sh -c 'for f; do echo \"ðŸ” Checking $f\"; if file \"$f\" | grep -q \"ELF\"; then if ! file \"$f\" | grep -q \"ARM aarch64\"; then echo \"âŒ Non-ARM64 Dart binary: $f\"; fi; fi; done' sh {} +
              echo 'âœ… Dart SDK binaries check done'

              # Verify Flutter engine binaries are ARM64
              echo 'ðŸ” Verifying Flutter engine binaries are ARM64...'
              find bin/cache/artifacts/engine/linux-arm64 -type f -exec sh -c 'for f; do echo \"ðŸ” Checking $f\"; if file \"$f\" | grep -q \"ELF\"; then if ! file \"$f\" | grep -q \"ARM aarch64\"; then echo \"âŒ Non-ARM64 engine binary: $f\"; fi; fi; done' sh {} +
              echo 'âœ… Flutter engine binaries check done'


              
              
              
              # Strip unnecessary platforms for lean SDK
              rm -rf bin/cache/artifacts/engine/darwin-*
              rm -rf bin/cache/artifacts/engine/windows-*
              rm -rf bin/cache/artifacts/engine/linux-x64
              rm -rf bin/cache/artifacts/engine/fuchsia-*
              rm -rf bin/cache/artifacts/engine/ios-*

              # Package SDK
              cd /workspace
              tar -czf flutter_linux_arm64_android_web_sdk.tar.gz flutter
              echo 'âœ… Super-lean ARM64 SDK packaged at /workspace/flutter_linux_arm64_android_web_sdk.tar.gz'
            "

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: flutter_linux_arm64_android_web_sdk
          path: flutter_linux_arm64_android_web_sdk.tar.gz

      - name: Get Flutter version for release
        id: flutterver
        run: |
          # Clone Flutter repo (quiet)
          git clone --quiet https://github.com/flutter/flutter.git
          cd flutter
      
          # Get latest stable tag (semantic version only)
          LATEST=$(git tag --list \
            | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' \
            | sort -V \
            | tail -n 1)
      
          if [ -z "$LATEST" ]; then
            echo "âŒ Failed to determine Flutter stable version"
            exit 1
          fi
      
          echo "Detected Flutter version: $LATEST"
      
          # Save as step output for use in release
          echo "flutterver=$LATEST" >> $GITHUB_OUTPUT
      
          # Optional: save in environment for later steps
          echo "FLUTTER_VERSION=$LATEST" >> $GITHUB_ENV

          - name: Rename artifact to include Flutter version
            run: |
            mv flutter_linux_arm64_android_web_sdk.tar.gz \ flutter_v${{ steps.flutterver.outputs.flutterver }}_linux_arm64_android_web_sdk.tar.gz
      
      - name: Publish SDK to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "flutter-${{ steps.flutterver.outputs.flutterver }}-${{ github.run_number }}-linux"
          name: "Flutter ${{ steps.flutterver.outputs.flutterver }} Linux ARM64 SDK"
          files: "./flutter_v${{ steps.flutterver.outputs.flutterver }}_linux_arm64_android_web_sdk.tar.gz"
          body: |
            This release provides a fully native Flutter SDK for Linux ARM64, prebuilt for quick setup.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
