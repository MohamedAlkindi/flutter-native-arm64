name: Flutter ARM64 Engine Artifacts

on:
  workflow_dispatch:

jobs:
  fetch-arm64-artifacts:
    runs-on: ubuntu-latest

    steps:

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU for ARM64
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Create working directories
        run: |
          mkdir -p /tmp/flutter-sdk
          mkdir -p /tmp/flutter-arm64

      - name: Install dependencies & clone Flutter SDK
        run: |
          docker run --rm --platform linux/arm64 \
            -v /tmp/flutter-sdk:/usr/local/flutter \
            -v /tmp/flutter-arm64:/workspace \
            arm64v8/ubuntu:22.04 bash -c "
              set -e
              apt-get update
              apt-get install -y curl unzip git xz-utils file ca-certificates openjdk-11-jdk cmake ninja-build
              git config --global --add safe.directory /usr/local/flutter
              git clone https://github.com/flutter/flutter.git --branch 3.35.2 --depth 1 /usr/local/flutter
              export PATH=/usr/local/flutter/bin:\$PATH
              flutter doctor
              flutter precache --linux
            "

      - name: Verify and copy ARM64 engine artifacts
        run: |
          docker run --rm --platform linux/arm64 \
            -v /tmp/flutter-sdk:/usr/local/flutter \
            -v /tmp/flutter-arm64:/workspace \
            arm64v8/ubuntu:22.04 bash -c "
              set -e
              ARTIFACTS_DIR=/usr/local/flutter/bin/cache/artifacts/engine/linux-arm64
              FILES=(
                frontend_server_aot.dart.snapshot
                const_finder.dart.snapshot
                gen_snapshot
                flutter_tester
                impellerc
                libpath_ops.so
                libtessellator.so
                isolate_snapshot.bin
                vm_isolate_snapshot.bin
              )
              for f in \"\${FILES[@]}\"; do
                if [ ! -f \"\$ARTIFACTS_DIR/\$f\" ]; then
                  echo \"❌ Missing artifact: \$f\"
                  ls -la \$ARTIFACTS_DIR
                  exit 1
                fi
                ARCH=\$(file \"\$ARTIFACTS_DIR/\$f\" | grep -o 'aarch64')
                if [ \"\$ARCH\" != \"aarch64\" ]; then
                  echo \"❌ Invalid architecture for \$f: not ARM64\"
                  exit 1
                fi
                echo \"✅ Verified ARM64: \$f\"
                cp \"\$ARTIFACTS_DIR/\$f\" /workspace/
              done
            "

      - name: Upload verified ARM64 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: flutter_arm64_artifacts
          path: /tmp/flutter-arm64/*
          retention-days: 7
