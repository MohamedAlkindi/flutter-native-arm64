name: Fetch Flutter ARM64 Snapshot

on:
  workflow_dispatch:

jobs:
  fetch-snapshot:
    runs-on: self-hosted
    # Ensure your self-hosted runner is a native ARM64 machine (e.g., Apple M1/M2, Raspberry Pi)
    # The runner must also have Docker, Git, and a compatible shell installed.

    steps:
      - name: Fetch Flutter snapshot on native ARM64 host
        run: |
          # The script is designed to run directly on the self-hosted ARM64 runner.
          set -e
          
          # Use a temporary directory to avoid conflicts with other jobs
          TEMP_DIR=$(mktemp -d)
          cd "$TEMP_DIR"

          echo "üöÄ Cloning the Flutter SDK repository to $TEMP_DIR..."
          git clone https://github.com/flutter/flutter.git --branch 3.35.2 --depth 1 ./flutter_sdk

          # Set up the Flutter environment variables for the current shell session
          export PATH="$PATH:$TEMP_DIR/flutter_sdk/bin"

          echo "üì¶ Pre-caching artifacts for Linux ARM64..."
          # This command will download the specific frontend_server.aot.dart.snapshot
          # and other necessary artifacts for the arm64 architecture.
          flutter precache --linux-arm64

          # Define the exact path to the snapshot file
          SNAPSHOT_FILE="$TEMP_DIR/flutter_sdk/bin/cache/artifacts/engine/linux-arm64/frontend_server.aot.dart.snapshot"

          # Verify that the file was successfully downloaded and exists
          if [ ! -f "$SNAPSHOT_FILE" ]; then
            echo "‚ùå The snapshot file was not found after precaching."
            exit 1
          fi

          echo "üîç Analyzing the snapshot file..."
          # The 'file' command is a great way to verify the file type and architecture.
          file "$SNAPSHOT_FILE"
          
          echo "‚úÖ Snapshot successfully downloaded and verified."

          # Copy the snapshot to a known location for the next step.
          cp "$SNAPSHOT_FILE" /home/runner/work/frontend_server.aot.dart.snapshot
        
      - name: Upload snapshot artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend_server_aot_snapshot
          path: /home/runner/work/frontend_server.aot.dart.snapshot
          retention-days: 7
