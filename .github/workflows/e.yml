name: Fetch Flutter 3.35.2 ARM64 frontend_server_aot snapshot

on:
  workflow_dispatch:

jobs:
  fetch-frontend-snapshot:
    runs-on: ubuntu-latest

    steps:
      - name: Enable QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Fetch snapshot inside ARM64 container
        run: |
          docker run --rm --platform linux/arm64 \
            -v $PWD:/workspace \
            -w /workspace \
            arm64v8/ubuntu:22.04 bash -c "
              set -x

              # Install minimal dependencies
              apt-get update
              apt-get install -y curl git file unzip ca-certificates

              # Download Flutter 3.35.2 SDK tarball (stable channel)
              curl -L -o flutter_linux_arm64_3.35.2.tar.xz https://storage.googleapis.com/flutter_infra_release/releases/stable/linux/flutter_linux_3.35.2-stable.tar.xz

              # Extract only the needed snapshot
              mkdir -p flutter
              tar -xJf flutter_linux_arm64_3.35.2.tar.xz -C flutter --strip-components=1 bin/cache/artifacts/engine/linux-arm64/frontend_server_aot.dart.snapshot

              # Verify the file
              file flutter/bin/cache/artifacts/engine/linux-arm64/frontend_server_aot.dart.snapshot

              # Upload artifact to workspace
              mkdir -p /workspace/artifacts
              cp flutter/bin/cache/artifacts/engine/linux-arm64/frontend_server_aot.dart.snapshot /workspace/artifacts/
            "

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend_server_aot_snapshot
          path: artifacts/frontend_server_aot.dart.snapshot
