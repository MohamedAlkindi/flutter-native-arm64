name: Fetch Flutter ARM64 Snapshot

on:
  workflow_dispatch:

jobs:
  fetch-snapshot:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Enable QEMU for ARM64
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Fetch only frontend_server_aot snapshot
        id: fetch-snapshot
        run: |
          mkdir -p ./.tmp && cd ./.tmp

          docker run --rm --platform linux/arm64 \
            -v "$PWD:/workspace" \
            -w /workspace \
            arm64v8/ubuntu:22.04 bash -c "
              # Minimal dependencies
              apt-get update && apt-get install -y git curl unzip ca-certificates file xz-utils

              # Clone Flutter SDK (3.35.2)
              git clone --depth 1 --branch 3.35.2 https://github.com/flutter/flutter.git flutter
              export PATH=\"/workspace/flutter/bin:\$PATH\"

              # Trigger snapshot generation via flutter tool
              flutter --version  # this triggers minimal setup
              
              # Path to the snapshot
              SNAPSHOT=/workspace/flutter/bin/cache/artifacts/engine/linux-arm64/frontend_server_aot.dart.snapshot

              if [ ! -f \"\$SNAPSHOT\" ]; then
                echo 'âŒ Snapshot file was not generated!'
                exit 1
              fi

              # Verify snapshot
              echo 'ðŸ” Snapshot info:'
              file \"\$SNAPSHOT\"

              # Copy to workspace root for upload
              cp \"\$SNAPSHOT\" /workspace/frontend_server_aot.dart.snapshot
            "

          echo "snapshot_path=./.tmp/frontend_server_aot.dart.snapshot" >> "$GITHUB_OUTPUT"

      - name: Upload snapshot artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend_server_aot_snapshot
          path: ${{ steps.fetch-snapshot.outputs.snapshot_path }}
          retention-days: 7
