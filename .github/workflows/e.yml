name: Fetch Flutter ARM64 Snapshot

on:
  workflow_dispatch:

jobs:
  fetch-snapshot:
    runs-on: ubuntu-latest

    steps:
      - name: Enable QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Fetch Flutter snapshot inside ARM64 container
        run: |
          docker run --rm --platform linux/arm64 \
            -v $PWD:/workspace \
            -w /workspace \
            arm64v8/ubuntu:22.04 bash -c "
              set +e
              
              apt-get update && apt-get install -y curl unzip file ca-certificates

              # Create workspace for Flutter SDK
              mkdir -p flutter && cd flutter

              # Download Flutter SDK (stable 3.35.2) but do not precache
              curl -L https://storage.googleapis.com/flutter_infra_release/releases/stable/linux/flutter_linux_3.35.2-stable.tar.xz -o flutter.tar.xz
              tar -xf flutter.tar.xz --strip-components=1
              
              # Verify and extract only the frontend_server_aot.dart.snapshot
              SNAPSHOT_FILE=bin/cache/artifacts/engine/linux-arm64/frontend_server_aot.dart.snapshot
              if [ ! -f \"$SNAPSHOT_FILE\" ]; then
                echo \"‚ùå Snapshot file not found: $SNAPSHOT_FILE\"
                exit 1
              fi
              echo \"üîç Checking snapshot...\"
              file \"$SNAPSHOT_FILE\"
              head -c 64 \"$SNAPSHOT_FILE\"

              # Copy snapshot to workspace root for upload
              cp \"$SNAPSHOT_FILE\" /workspace/frontend_server_aot.dart.snapshot
            "

      - name: Upload snapshot artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend_server_aot_snapshot
          path: frontend_server_aot.dart.snapshot
