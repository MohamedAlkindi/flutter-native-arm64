name: Flutter ARM64 Full Build

on:
  workflow_dispatch:

jobs:
  flutter-build:
    runs-on: ubuntu-latest

    env:
      JAVA_HOME: /usr/lib/jvm/java-11-openjdk-amd64
      ANDROID_HOME: ${{ runner.temp }}/android-sdk
      ANDROID_SDK_ROOT: ${{ runner.temp }}/android-sdk
      PATH: ${{ runner.temp }}/android-sdk/cmdline-tools/latest/bin:${{ runner.temp }}/android-sdk/platform-tools:${{ runner.temp }}/android-sdk/emulator:$PATH

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl unzip git xz-utils openjdk-11-jdk build-essential cmake

      - name: Setup Android SDK
        run: |
          mkdir -p $ANDROID_SDK_ROOT/cmdline-tools
          curl -o commandlinetools.zip https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
          unzip commandlinetools.zip -d $ANDROID_SDK_ROOT/cmdline-tools
          mv $ANDROID_SDK_ROOT/cmdline-tools/cmdline-tools $ANDROID_SDK_ROOT/cmdline-tools/latest
          yes | sdkmanager --licenses
          sdkmanager "platform-tools" "platforms;android-36" "ndk;25.2.9519653" "cmake;3.22.1"

      - name: Download Flutter 3.35.2 (ARM64)
        run: |
          git clone https://github.com/flutter/flutter.git --branch 3.35.2 --depth 1 ${{ runner.temp }}/flutter
          export PATH="${{ runner.temp }}/flutter/bin:$PATH"
          flutter doctor

      - name: Create sample Flutter project
        run: |
          flutter create sample_app
          cd sample_app

      - name: Get Flutter dependencies
        run: |
          cd sample_app
          flutter pub get

      - name: Build APK (default)
        run: |
          cd sample_app
          flutter build apk

      - name: Verify generated snapshots
        run: |
          file ${{ runner.temp }}/flutter/bin/cache/artifacts/engine/linux-arm64/frontend_server_aot.dart.snapshot
          ls -lh ${{ runner.temp }}/flutter/bin/cache/artifacts/engine/linux-arm64

      - name: Upload snapshot artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend_server_aot_snapshot
          path: ${{ runner.temp }}/flutter/bin/cache/artifacts/engine/linux-arm64/frontend_server_aot.dart.snapshot
          retention-days: 7
